<ci:SettingsPageBase x:Class="DutyIsland.Views.SettingPages.DutySettingsPage"
                     xmlns="https://github.com/avaloniaui"
                     xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                     xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                     xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                     xmlns:ci="http://classisland.tech/schemas/xaml/core"
                     xmlns:fa="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
                     xmlns:local="clr-namespace:DutyIsland.Views.SettingPages"
                     xmlns:controls="clr-namespace:DutyIsland.Controls"
                     xmlns:converters="clr-namespace:DutyIsland.Converters"
                     xmlns:enums="clr-namespace:DutyIsland.Enums"
                     xmlns:system="clr-namespace:System;assembly=System.Runtime"
                     mc:Ignorable="d">
    <ci:SettingsPageBase.Resources>
        <converters:HumanSexToStringConverter x:Key="HumanSexToStringConverter" />
        <system:String x:Key="NoDutyPlanString">未绑定值日表</system:String>
    </ci:SettingsPageBase.Resources>
    
    <ci:SettingsPageBase.Styles>
        <Style Selector="ListBox.drag ListBoxItem">
            <Setter Property="Interaction.Behaviors">
                <BehaviorCollectionTemplate>
                    <BehaviorCollection>
                        <ci:AdvancedItemDragBehavior HorizontalDragThreshold="21879066"
                                                     Orientation="Vertical"
                                                     VerticalDragThreshold="3" />
                    </BehaviorCollection>
                </BehaviorCollectionTemplate>
            </Setter>
        </Style>
    </ci:SettingsPageBase.Styles>

    
    <Grid RowDefinitions="*, Auto" DataContext="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=local:DutySettingsPage}}">
        <TabControl Grid.Row="0">
            <TabItem IsEnabled="False">
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontSize="20">DutyIsland</TextBlock>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <ci:Empty Text="你真厉害，居然来到这里了。"
                          Icon="{ci:FluentIconSource &#xE059;, FontSize=48}"/>
            </TabItem>
            
            <TabItem IsSelected="True">
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <ci:FluentIcon Glyph="&#xE994;" FontSize="20" Height="20" VerticalAlignment="Center" />
                            <TextBlock FontSize="20">主页</TextBlock>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <ScrollViewer>
                    <StackPanel Classes="settings-container animated-intro" Spacing="8">
                        <fa:InfoBar IsOpen="True" IsVisible="True" Severity="Informational">
                            <fa:InfoBar.Message>
                                欢迎使用 DutyIsland！找不到启用值日表的地方？看看课表的附加设置吧。
                            </fa:InfoBar.Message>
                        </fa:InfoBar>
                        
                        <fa:InfoBar IsOpen="True" IsVisible="True" Severity="Success">
                            <fa:InfoBar.Message>
                                自动提醒功能已推出！该功能类似于自动化工作流 cron + 提醒值日人员，但更方便。
                            </fa:InfoBar.Message>
                        </fa:InfoBar>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
           
            <TabItem IsVisible="{Binding ViewModel.Settings.DutyPlanGetMode, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static enums:DutyPlanGetMode.AutoRolling}}">
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <ci:FluentIcon Glyph="&#xE356;" FontSize="20" Height="20" VerticalAlignment="Center" />
                            <TextBlock FontSize="20">轮换</TextBlock>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <Grid RowDefinitions="Auto *">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="5" />
                        <ColumnDefinition Width="350" MinWidth="300" MaxWidth="450" />
                    </Grid.ColumnDefinitions>
                    
                    <fa:CommandBar Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="3"
                                   DefaultLabelPosition="Right" Classes="hide-popup-indicator">
                        <fa:CommandBar.PrimaryCommands>
                            <fa:CommandBarButton Click="ButtonAddRollItem_OnClick" 
                                                 IconSource="{ci:FluentIconSource &#xE308;}"
                                                 Label="添加" ToolTip.Tip="添加轮换项目。"/>
                            
                            <fa:CommandBarButton Click="ButtonRemoveRollItem_OnClick"
                                                 Label="删除" ToolTip.Tip="删除选中的轮换项目。"
                                                 IsEnabled="{Binding ViewModel.SelectedRollItem, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <fa:CommandBarButton.IconSource>
                                    <fa:SymbolIconSource Symbol="Remove"/>
                                </fa:CommandBarButton.IconSource>
                            </fa:CommandBarButton>
                        </fa:CommandBar.PrimaryCommands>
                    </fa:CommandBar>
                        
                    <ScrollViewer Grid.Row="1" Grid.Column="0">
                        <Grid ColumnDefinitions="Auto *">
                            <ListBox Grid.Column="0"
                                     IsEnabled="False"
                                     ItemsSource="{Binding ViewModel.RollIndexItems}">
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <VirtualizingStackPanel Classes="animated-intro" />
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                                
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock HorizontalAlignment="Right" VerticalAlignment="Center" Text="{Binding}" />
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                            
                            <ListBox Grid.Column="1"
                                     Classes="drag"
                                     SelectionMode="Single"
                                     ItemsSource="{Binding ViewModel.Rolling.RollItems}"
                                     SelectedItem="{Binding ViewModel.SelectedRollItem}">
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <VirtualizingStackPanel Classes="animated-intro" />
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                            
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="8">
                                            <ci:TouchDragThumb Margin="-12 0 0 0"
                                                               VerticalAlignment="Center"
                                                               Width="20" IsExplicitVisible="True" />
                                        
                                            <TextBlock VerticalAlignment="Center"
                                                       Text="无值日安排"
                                                       IsVisible="{Binding !HasDutyPlan}"/>
                                        
                                            <TextBlock VerticalAlignment="Center"
                                                       Text="{Binding DutyPlan.Name, FallbackValue={StaticResource NoDutyPlanString}}"
                                                       IsVisible="{Binding HasDutyPlan}" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </ScrollViewer>
                    
                    <GridSplitter Grid.Row="1" Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" />

                    <ScrollViewer Grid.Row="1" Grid.Column="2" Margin="8">
                        <Grid RowDefinitions="Auto, Auto, Auto">
                            <StackPanel Grid.Row="0" Spacing="4">
                                <TextBlock Text="轮换设置" Theme="{StaticResource SubtitleTextBlockStyle}" />
                                
                                <ci:Field Label="当前轮换索引">
                                    <NumericUpDown Value="{Binding ViewModel.Rolling.RollIndex}" Increment="1" FormatString="0" />
                                </ci:Field>
                                
                                <ci:Field Label="轮换间隔天数">
                                    <NumericUpDown Value="{Binding ViewModel.Rolling.RollDays}" Increment="1" FormatString="0" />
                                </ci:Field>
                                
                                <CheckBox IsChecked="{Binding ViewModel.Rolling.RollOnUnopenDay}">
                                    未开启 ClassIsland 也轮换
                                </CheckBox>
                                
                                <CheckBox IsChecked="{Binding ViewModel.Rolling.SkipWeekend}">
                                    跳过周末
                                </CheckBox>
                                
                                <CheckBox IsEnabled="False">
                                    跳过节假日(还未新建文件夹)
                                </CheckBox>
                                
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock VerticalAlignment="Center" Text="上次轮换日期：" />
                                    <TextBlock VerticalAlignment="Center" Text="{Binding ViewModel.Rolling.LastChangedDate}" />
                                    <Button Margin="4 0 0 0" VerticalAlignment="Center"
                                            Click="ButtonManualUpdateRolling_OnClick"
                                            ToolTip.Tip="适用于半夜不关 ci">
                                        手动触发更新
                                    </Button>
                                </StackPanel>
                            </StackPanel>
                            
                            <Separator Grid.Row="1" Margin="-8 16"/>
                            
                            <ci:Emptiable Grid.Row="2" IsDirectContentMode="True"
                                          Data="{Binding ViewModel.SelectedRollItem}">
                                <StackPanel Spacing="8">
                                    <TextBlock Text="轮换项目信息" Theme="{StaticResource SubtitleTextBlockStyle}"/>
                                    
                                    <CheckBox IsChecked="{Binding ViewModel.SelectedRollItem.HasDutyPlan}">
                                        有值日安排?
                                    </CheckBox>
                                    
                                    <ComboBox ItemsSource="{Binding ViewModel.DutyPlans.List}"
                                              SelectedValue="{Binding ViewModel.SelectedRollItem.DutyPlanGuid}"
                                              SelectedValueBinding="{Binding Key}">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Value.Name}"
                                                           ToolTip.Tip="{Binding Key}" />
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                            </ci:Emptiable> 
                        </Grid>
                    </ScrollViewer>
                </Grid>
            </TabItem>
            
            <TabItem>
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <ci:FluentIcon Glyph="&#xE324;" FontSize="20" Height="20" VerticalAlignment="Center" />
                            <TextBlock FontSize="20">值日表</TextBlock>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="250" MinWidth="250" MaxWidth="400"/>
                        <ColumnDefinition Width="5"/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    
                    <Grid Grid.Column="0" RowDefinitions="Auto, *">
                        <fa:CommandBar Grid.Row="0"
                                       DefaultLabelPosition="Right">
                            <fa:CommandBar.PrimaryCommands>
                                <fa:CommandBarButton IconSource="{ci:FluentIconSource &#xE00D;}"
                                                     Label="添加" ToolTip.Tip="新建一个值日表。"
                                                     Click="ButtonAddDutyPlan_OnClick"/>
                                <fa:CommandBarSeparator />
                                <fa:CommandBarButton IconSource="{ci:FluentIconSource &#xE58D;}" 
                                                     Label="复制" ToolTip.Tip="复制一个当前选中的值日表的副本。"
                                                     Click="ButtonDuplicateDutyPlan_OnClick"/>
                            </fa:CommandBar.PrimaryCommands>
                        </fa:CommandBar>
                        
                        <ListBox Grid.Row="1"
                                 ItemsSource="{Binding ViewModel.DutyPlans.List}"
                                 SelectedValue="{Binding ViewModel.SelectedDutyPlan}"
                                 SelectedValueBinding="{Binding Value}">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Value.Name}" VerticalAlignment="Center" />
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                    
                    <GridSplitter Grid.Column="1" Margin="2 0" />
                    
                    <ci:Emptiable Grid.Column="2" IsDirectContentMode="True"
                                  Data="{Binding ViewModel.SelectedDutyPlan}">
                        <Grid RowDefinitions="Auto *">
                            <fa:CommandBar Grid.Row="0" DefaultLabelPosition="Right" Classes="hide-popup-indicator">
                                <fa:CommandBar.PrimaryCommands>
                                    <fa:CommandBarButton IconSource="{ci:FluentIconSource &#xEFDD;}"
                                                         Label="导入" ToolTip.Tip="从文本快速导入值日执行者。">
                                        <fa:CommandBarButton.Flyout>
                                            <Flyout>
                                                <StackPanel Spacing="8">
                                                    <TextBlock Text="在下方粘贴值日名单，一行一个执行者。" />
                                                    <TextBlock Text="导入时将会按值日项的「标准人数」自动填充。" />
                                                    <TextBox Height="64" AcceptsReturn="True" Text="{Binding ViewModel.ImportDutyPlanText}" />
                                                    <TextBlock Text="导入后将会覆盖已有执行者信息！此操作无法撤销。" />
                                                    <Button Content="导入" Classes="accent" Click="ButtonImportDutyPlan_OnClick"/>
                                                </StackPanel>
                                            </Flyout>
                                        </fa:CommandBarButton.Flyout>
                                    </fa:CommandBarButton>
                                    
                                    <fa:CommandBarSeparator/>
                                    
                                    <fa:CommandBarButton IconSource="{ci:FluentIconSource &#xE61D;}"
                                                         Label="删除值日表" ToolTip.Tip="删除该值日表。">
                                        <fa:CommandBarButton.Flyout>
                                            <Flyout>
                                                <StackPanel Spacing="8">
                                                    <TextBlock FontWeight="Bold">
                                                        <Run Text="要删除值日表「" />
                                                        <Run Text="{Binding ViewModel.SelectedDutyPlan.Name}" />
                                                        <Run Text="」吗？" />
                                                    </TextBlock>
                                                    <TextBlock Text="使用了该值日表的附加设置将会失效！且此操作无法撤销。" />
                                                    <Button Content="删除" Classes="accent" Click="ButtonDeleteSelectedDutyPlan_OnClick"/>
                                                </StackPanel>
                                            </Flyout>
                                        </fa:CommandBarButton.Flyout>
                                    </fa:CommandBarButton>
                                </fa:CommandBar.PrimaryCommands>
                            </fa:CommandBar>
                            
                            <Grid Grid.Row="1">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="5" />
                                    <ColumnDefinition Width="350" MinWidth="300" MaxWidth="450" />
                                </Grid.ColumnDefinitions>
                                
                                <ListBox Grid.Column="0" Margin="0 0 4 0"
                                         ItemsSource="{Binding ViewModel.SelectedDutyPlan.ComplexItems.List, UpdateSourceTrigger=PropertyChanged}"
                                         SelectedItem="{Binding ViewModel.SelectedDutyPlanItemKvp}">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Grid ColumnDefinitions="Auto, *">
                                                <TextBlock Grid.Column="0" FontSize="13"
                                                           Text="{Binding Value.Second.Name}" VerticalAlignment="Center" />
                                                
                                                <ItemsControl Grid.Column="1" HorizontalAlignment="Right" FontSize="11"
                                                              ItemsSource="{Binding Value.First.Workers.Items}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <WrapPanel Orientation="Horizontal" ItemSpacing="4" />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <TextBlock Foreground="Gray">
                                                                <Run Text="{Binding Name}" />
                                                            </TextBlock>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </Grid>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>

                                <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" />

                                <ScrollViewer Grid.Column="2" Margin="8">
                                    <Grid RowDefinitions="Auto, Auto, Auto">
                                        <StackPanel Grid.Row="0" Spacing="8">
                                            <TextBlock Text="值日表信息" Theme="{StaticResource SubtitleTextBlockStyle}" />
                                            
                                            <ci:Field Label="名称">
                                                <TextBox Text="{Binding ViewModel.SelectedDutyPlan.Name}"/>
                                            </ci:Field>
                                            
                                            <ci:Field Label="模板">
                                                <ComboBox ItemsSource="{Binding ViewModel.DutyPlanTemplates.List}"
                                                          SelectedItem="{Binding ViewModel.DutyPlanSelectedDutyPlanTemplateKvp}"
                                                          SelectedValue="{Binding ViewModel.SelectedDutyPlan.TemplateGuid}"
                                                          SelectedValueBinding="{Binding Key}">
                                                    <ComboBox.ItemTemplate>
                                                        <DataTemplate>
                                                            <TextBlock Text="{Binding Value.TemplateName}"
                                                                       ToolTip.Tip="{Binding Key}" />
                                                        </DataTemplate>
                                                    </ComboBox.ItemTemplate>
                                                </ComboBox>
                                            </ci:Field>
                                        </StackPanel>
                                        
                                        <Separator Grid.Row="1" Margin="-8 16"/>
                                        
                                        <ci:Emptiable Grid.Row="2" IsDirectContentMode="True"
                                                      Data="{Binding ViewModel.SelectedDutyPlanItemKvp}">
                                            <StackPanel Spacing="8">
                                                <TextBlock Text="任务信息" Theme="{StaticResource SubtitleTextBlockStyle}"/>
                                                <TextBlock>
                                                    <Run Text="任务名称:" />
                                                    <Run Text="{Binding ViewModel.SelectedDutyPlanItemKvp.Value.Second.Name}" />
                                                </TextBlock>
                                                <TextBlock>
                                                    <Run Text="标准人数:" />
                                                    <Run Text="{Binding ViewModel.SelectedDutyPlanItemKvp.Value.Second.WorkerCount}" />
                                                </TextBlock>
                                                
                                                <controls:WorkersDataGridControl Workers="{Binding ViewModel.SelectedDutyPlanItemKvp.Value.First.Workers}" />
                                            </StackPanel>
                                        </ci:Emptiable> 
                                    </Grid>
                                </ScrollViewer>
                            </Grid>
                        </Grid>
                    </ci:Emptiable>
                </Grid>
            </TabItem>
            
            <TabItem>
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <ci:FluentIcon Glyph="&#xE31C;" FontSize="20" Height="20" VerticalAlignment="Center" />
                            <TextBlock FontSize="20">值日表模板</TextBlock>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="250" MinWidth="250" MaxWidth="400"/>
                        <ColumnDefinition Width="5"/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    
                    <Grid Grid.Column="0" RowDefinitions="Auto, *">
                        <fa:CommandBar Grid.Row="0"
                                       DefaultLabelPosition="Right">
                            <fa:CommandBar.PrimaryCommands>
                                <fa:CommandBarButton IconSource="{ci:FluentIconSource &#xE00D;}"
                                                     Label="添加" ToolTip.Tip="新建一个值日表模板。"
                                                     Click="ButtonAddDutyPlanTemplate_OnClick"/>
                                <fa:CommandBarSeparator />
                                <fa:CommandBarButton IconSource="{ci:FluentIconSource &#xE58D;}" 
                                                     Label="复制" ToolTip.Tip="复制一个当前选中的值日表模板的副本。"
                                                     Click="ButtonDuplicateDutyPlanTemplate_OnClick"/>
                            </fa:CommandBar.PrimaryCommands>
                        </fa:CommandBar>
                        
                        <ListBox Grid.Row="1"
                                 ItemsSource="{Binding ViewModel.DutyPlanTemplates.List}"
                                 SelectedValue="{Binding ViewModel.SelectedDutyPlanTemplate}"
                                 SelectedValueBinding="{Binding Value}">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Value.TemplateName}" VerticalAlignment="Center" />
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                    
                    <GridSplitter Grid.Column="1" Margin="2 0" />
                    
                    <ci:Emptiable Grid.Column="2" IsDirectContentMode="True"
                                  Data="{Binding ViewModel.SelectedDutyPlanTemplate}">
                        <Grid RowDefinitions="Auto *">
                            <fa:CommandBar Grid.Row="0" DefaultLabelPosition="Right" Classes="hide-popup-indicator">
                                <fa:CommandBar.PrimaryCommands>
                                    <fa:CommandBarButton Click="ButtonAddDutyPlanTemplateItem_OnClick" 
                                                         IconSource="{ci:FluentIconSource &#xF198;}"
                                                         Label="添加任务" ToolTip.Tip="添加值日任务。"/>
                                    
                                    <fa:CommandBarButton Click="ButtonRemoveDutyPlanTemplateItem_OnClick"
                                                         Label="删除" ToolTip.Tip="删除选中的值日任务。"
                                                         IsEnabled="{Binding ViewModel.SelectedDutyPlanTemplateItem, Converter={x:Static ObjectConverters.IsNotNull}}">
                                        <fa:CommandBarButton.IconSource>
                                            <fa:SymbolIconSource Symbol="Remove"/>
                                        </fa:CommandBarButton.IconSource>
                                    </fa:CommandBarButton>
                                    
                                    <fa:CommandBarSeparator/>
                                    
                                    <fa:CommandBarButton IconSource="{ci:FluentIconSource &#xE61D;}"
                                                         Label="删除模板" ToolTip.Tip="删除该值日表模板。">
                                        <fa:CommandBarButton.Flyout>
                                            <Flyout>
                                                <StackPanel Spacing="8">
                                                    <TextBlock FontWeight="Bold">
                                                        <Run Text="要删除值日表模板「" />
                                                        <Run Text="{Binding ViewModel.SelectedDutyPlanTemplate.TemplateName}" />
                                                        <Run Text="」吗？" />
                                                    </TextBlock>
                                                    <TextBlock Text="此操作无法撤销。" />
                                                    <Button Content="删除" Classes="accent" Click="ButtonDeleteSelectedDutyPlanTemplate_OnClick"/>
                                                </StackPanel>
                                            </Flyout>
                                        </fa:CommandBarButton.Flyout>
                                    </fa:CommandBarButton>
                                </fa:CommandBar.PrimaryCommands>
                            </fa:CommandBar>
                            
                            <Grid Grid.Row="1">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="5" />
                                    <ColumnDefinition Width="350" MinWidth="300" MaxWidth="450" />
                                </Grid.ColumnDefinitions>

                                <DataGrid Grid.Column="0" Margin="0 0 4 0"
                                          AutoGenerateColumns="False"
                                          CanUserSortColumns="False"
                                          RowHeaderWidth="150"
                                          GridLinesVisibility="Horizontal"
                                          IsReadOnly="False"
                                          ItemsSource="{Binding ViewModel.SelectedDutyPlanTemplate.WorkerTemplateDictionary}"
                                          SelectedItem="{Binding ViewModel.SelectedDutyPlanTemplateItemKvp}">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Binding="{Binding Value.Name, Mode=TwoWay}"
                                                            Header="任务名称" IsReadOnly="False" />
                                        
                                        <DataGridTemplateColumn Header="标准人数" MinWidth="100" IsReadOnly="False">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Value.WorkerCount}"
                                                               VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                            <DataGridTemplateColumn.CellEditingTemplate>
                                                <DataTemplate>
                                                    <NumericUpDown Value="{Binding Value.WorkerCount}"
                                                                   FormatString="0"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellEditingTemplate>
                                        </DataGridTemplateColumn>
                                        
                                        <DataGridCheckBoxColumn Binding="{Binding Value.NotificationTimes.Enable, Mode=TwoWay}"
                                                                Header="启用提醒?" IsReadOnly="False" />
                                    </DataGrid.Columns>
                                </DataGrid>

                                <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" />

                                <ScrollViewer Grid.Column="2" Margin="8">
                                    <Grid RowDefinitions="Auto, Auto, Auto">
                                        <StackPanel Grid.Row="0" Spacing="8"
                                                    DataContext="{Binding ViewModel.SelectedDutyPlanTemplate}">
                                            <TextBlock Text="值日表模板信息" Theme="{StaticResource SubtitleTextBlockStyle}" />
                                            
                                            <ci:Field Label="名称">
                                                <TextBox Text="{Binding TemplateName}"/>
                                            </ci:Field>
                                        </StackPanel>
                                        
                                        <Separator Grid.Row="1" Margin="-8 16"/>
                                        
                                        <ci:Emptiable Grid.Row="2" IsDirectContentMode="True"
                                                      Data="{Binding ViewModel.SelectedDutyPlanTemplateItemKvp}">
                                            <StackPanel Spacing="8" DataContext="{Binding ViewModel.SelectedDutyPlanTemplateItemKvp.Value}">
                                                <TextBlock Text="任务信息" Theme="{StaticResource SubtitleTextBlockStyle}"/>
                                                
                                                <ci:Field Label="任务名称">
                                                    <TextBox Text="{Binding Name}"/>
                                                </ci:Field>
                                                
                                                <ci:Field Label="标准人数">
                                                    <NumericUpDown Text="{Binding WorkerCount}" FormatString="0"/>
                                                </ci:Field>
                                                
                                                <Expander Classes="compact stretch-header" IsExpanded="{Binding NotificationTimes.Enable, Mode=OneWay}">
                                                    <Expander.Header>
                                                        <Grid ColumnDefinitions="*, Auto">
                                                            <ci:IconText Grid.Column="0" Glyph="&#xE02B;" Text="自动提醒设置" />
                                                            
                                                            <ToggleSwitch Grid.Column="1" Margin="0,-8,0,-4" VerticalAlignment="Center"
                                                                          OnContent="" OffContent="" ToolTip.Tip="是否启用提醒设置"
                                                                          IsChecked="{Binding NotificationTimes.Enable}"/>
                                                        </Grid>
                                                    </Expander.Header>
                                                    
                                                    <StackPanel Spacing="8">
                                                        <ci:Field Label="提醒时间">
                                                            <StackPanel>
                                                                <DataGrid AutoGenerateColumns="False"
                                                                          CanUserSortColumns="False"
                                                                          IsReadOnly="False"
                                                                          GridLinesVisibility="Horizontal"
                                                                          ItemsSource="{Binding NotificationTimes.Times}">
                                                                    <DataGrid.Columns>
                                                                        <DataGridTemplateColumn Header="时间">
                                                                            <DataGridTemplateColumn.CellTemplate>
                                                                                <DataTemplate>
                                                                                    <TimePicker SelectedTime="{Binding Time}" UseSeconds="True" />
                                                                                </DataTemplate>
                                                                            </DataGridTemplateColumn.CellTemplate>
                                                                        </DataGridTemplateColumn>
                            
                                                                        <DataGridTemplateColumn Header="操作">
                                                                            <DataGridTemplateColumn.CellTemplate>
                                                                                <DataTemplate>
                                                                                    <Button ToolTip.Tip="删除这个时间。" Foreground="IndianRed" Theme="{StaticResource TransparentButton}"
                                                                                            Command="{Binding DutyPlanTemplateRemoveNotificationTimeCommand, RelativeSource={RelativeSource FindAncestor, AncestorType=local:DutySettingsPage}}"
                                                                                            CommandParameter="{Binding}">
                                                                                        <ci:IconText Glyph="&#xE61D;" Text="删除" />
                                                                                    </Button>
                                                                                </DataTemplate>
                                                                            </DataGridTemplateColumn.CellTemplate>
                                                                        </DataGridTemplateColumn>
                                                                    </DataGrid.Columns>
                                                                </DataGrid>
                    
                                                                <Button ToolTip.Tip="添加一个时间。" Margin="0 4 0 0"
                                                                        Click="DutyPlanTemplateAddNotificationTimeButton_OnClick">
                                                                    <ci:IconText Glyph="&#xE00D;" Text="添加" />
                                                                </Button>
                                                            </StackPanel>
                                                        </ci:Field>
                                                    </StackPanel>
                                                </Expander>
                                                
                                                <Expander Classes="compact stretch-header" IsExpanded="True">
                                                    <Expander.Header>
                                                        <ci:IconText Grid.Column="0" Glyph="&#xE025;" Text="提醒设置" />
                                                    </Expander.Header>
                                                    
                                                    <controls:NotificationSettingsControl Settings="{Binding NotificationSettings}" />
                                                </Expander>
                                            </StackPanel>
                                        </ci:Emptiable>
                                    </Grid>
                                </ScrollViewer>
                            </Grid>
                        </Grid>
                    </ci:Emptiable>
                </Grid>
            </TabItem>
            
            <TabItem>
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <ci:FluentIcon Glyph="&#xECDB;" FontSize="20" Height="20" VerticalAlignment="Center" />
                            <TextBlock FontSize="20">人员</TextBlock>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <Grid RowDefinitions="Auto *">
                    <fa:CommandBar Grid.Row="0" DefaultLabelPosition="Right" Classes="hide-popup-indicator">
                        <fa:CommandBar.PrimaryCommands>
                            <fa:CommandBarButton Click="ButtonAddWorker_OnClick" 
                                                 IconSource="{ci:FluentIconSource &#xF198;}"
                                                 Label="添加人员" ToolTip.Tip="添加一位人员。"/>
                            
                            <fa:CommandBarButton Click="ButtonRemoveWorker_OnClick"
                                                 Label="删除" ToolTip.Tip="删除选中的人员。"
                                                 IsEnabled="{Binding ViewModel.SelectedWorkerItem, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <fa:CommandBarButton.IconSource>
                                    <fa:SymbolIconSource Symbol="Remove"/>
                                </fa:CommandBarButton.IconSource>
                            </fa:CommandBarButton>
                            
                            <fa:CommandBarSeparator />
                            
                            <fa:CommandBarButton Click="ButtonImportWorkers_OnClick"
                                                 IconSource="{ci:FluentIconSource &#xEFDD;}"
                                                 Label="导入" ToolTip.Tip="导入人员" />
                        </fa:CommandBar.PrimaryCommands>
                    </fa:CommandBar>
                    
                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="5" />
                            <ColumnDefinition Width="350" MinWidth="300" MaxWidth="450" />
                        </Grid.ColumnDefinitions>

                        <DataGrid Grid.Column="0" Margin="0 0 4 0"
                                  AutoGenerateColumns="False"
                                  CanUserSortColumns="False"
                                  RowHeaderWidth="150"
                                  GridLinesVisibility="Horizontal"
                                  IsReadOnly="False"
                                  ItemsSource="{Binding ViewModel.Workers}"
                                  SelectedItem="{Binding ViewModel.SelectedWorkerItem}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Binding="{Binding Name, Mode=TwoWay}"
                                                    Header="姓名" IsReadOnly="False" />
                                
                                <DataGridTextColumn Binding="{Binding Id, Mode=TwoWay}"
                                                    Header="编号" IsReadOnly="False" />
                                
                                <DataGridTemplateColumn Header="性别" IsReadOnly="False">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center"
                                                       Text="{Binding Sex, Converter={StaticResource HumanSexToStringConverter}}" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <fa:FAComboBox SelectedIndex="{Binding Sex}">
                                                <fa:FAComboBoxItem>男</fa:FAComboBoxItem>
                                                <fa:FAComboBoxItem>女</fa:FAComboBoxItem>
                                                <fa:FAComboBoxItem>未知</fa:FAComboBoxItem>
                                            </fa:FAComboBox>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" />

                        <ci:Emptiable Grid.Column="2" IsDirectContentMode="True"
                                      Data="{Binding ViewModel.SelectedWorkerItem}">
                            <ScrollViewer Margin="8">
                                <StackPanel Spacing="8" DataContext="{Binding ViewModel.SelectedWorkerItem}">
                                    <TextBlock Text="人员信息" Theme="{StaticResource SubtitleTextBlockStyle}"/>
                                    
                                    <ci:Field Label="姓名">
                                        <TextBox Text="{Binding Name}"/>
                                    </ci:Field>
                                    
                                    <ci:Field Label="编号">
                                        <TextBox Text="{Binding Id}"/>
                                    </ci:Field>
                                    
                                    <ci:Field Label="性别">
                                        <ListBox Theme="{StaticResource ChipListBoxTheme}" HorizontalAlignment="Left"
                                                 SelectionMode="Single" SelectedIndex="{Binding Sex}">
                                            <ListBoxItem>男</ListBoxItem>
                                            <ListBoxItem>女</ListBoxItem>
                                            <ListBoxItem>未知</ListBoxItem>
                                        </ListBox>
                                    </ci:Field>
                                </StackPanel>
                            </ScrollViewer>
                        </ci:Emptiable>
                    </Grid>
                </Grid>
            </TabItem>
            
            <TabItem>
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <ci:FluentIcon Glyph="&#xEF27;" FontSize="20" Height="20" VerticalAlignment="Center" />
                            <TextBlock FontSize="20">设置</TextBlock>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <ScrollViewer>
                    <StackPanel Classes="settings-container animated-intro">
                        <fa:SettingsExpander Header="DutyIsland" IsExpanded="True">
                            <fa:SettingsExpander.IconSource>
                                <fa:ImageIconSource Source="/Assets/PluginIcon.png"/>
                            </fa:SettingsExpander.IconSource>
                            
                            <fa:SettingsExpander.Footer>
                                <TextBlock FontSize="12" Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                                    <Run Text="{Binding PluginVersion}"/>
                                    <Run Text="(Codename Paimon)"/>
                                </TextBlock>
                            </fa:SettingsExpander.Footer>
                            
                            <fa:SettingsExpanderItem Description="本项目基于 GNU General Public License v3.0 获得许可。">
                                <fa:SettingsExpanderItem.Footer>
                                    <WrapPanel Classes="animated-resize" ItemSpacing="4">
                                        <HyperlinkButton Click="SettingsExpanderItemShowOssLicense_OnClick">
                                            <TextBlock Text="开放源代码许可"/>
                                        </HyperlinkButton>
                                    </WrapPanel>
                                </fa:SettingsExpanderItem.Footer>
                                
                                <TextBlock Background="Transparent" PointerPressed="UIElementAppInfo_OnMouseDown"
                                           Text="Copyright (c) 2025  lrs2187/lrsgzs"/>
                            </fa:SettingsExpanderItem>
                            
                            <fa:SettingsExpanderItem Content="常用链接">
                                <fa:SettingsExpanderItem.Footer>
                                    <WrapPanel Classes="animated-resize" ItemSpacing="4">
                                        <HyperlinkButton Click="UriNavigationCommands_OnClick"
                                                         CommandParameter="https://github.com/lrsgzs/DutyIsland">
                                            <TextBlock Text="GitHub"/>
                                        </HyperlinkButton>
                                        
                                        <HyperlinkButton Click="UriNavigationCommands_OnClick"
                                                         CommandParameter="https://qm.qq.com/q/PeyliibxE4">
                                            <TextBlock Text="加入插件交流 QQ 群"/>
                                        </HyperlinkButton>
                                    </WrapPanel>
                                </fa:SettingsExpanderItem.Footer>
                            </fa:SettingsExpanderItem>
                        </fa:SettingsExpander>
                        
                        <fa:SettingsExpander IconSource="{ci:FluentIconSource &#xF192;}" Header="值日表获取来源"
                                             Description="控制全局的值日表获取来源，选中「附加设置」时将会从当前启用的课表中的「值日表」附加设置获取，选中「轮换」时将会从轮换设置中获取。">
                            <fa:SettingsExpander.Footer>
                                <Grid>
                                    <TabStrip Classes="compact toggle" Theme="{StaticResource TabStripStyle}"
                                              SelectedIndex="{Binding ViewModel.Settings.DutyPlanGetMode}">
                                        <TabStripItem>
                                            <ci:IconText Classes="display-role" Glyph="&#xE6B1;" Text="附加设置" />
                                        </TabStripItem>
                                        <TabStripItem>
                                            <ci:IconText Classes="display-role" Glyph="&#xE356;" Text="轮换" />
                                        </TabStripItem>
                                    </TabStrip>
                                </Grid>
                            </fa:SettingsExpander.Footer>
                        </fa:SettingsExpander>
                        
                        <fa:SettingsExpander IconSource="{ci:FluentIconSource &#xE31C;}"
                                             Header="启用从托盘提醒?" Description="控制从托盘提醒的启用状态。">
                            <fa:SettingsExpander.Footer>
                                <ToggleSwitch IsChecked="{Binding ViewModel.Settings.EnableTaskBarNotificationMenu}"/>
                            </fa:SettingsExpander.Footer>
                        </fa:SettingsExpander>
                        
                        <fa:SettingsExpander IconSource="{ci:FluentIconSource &#xE31C;}"
                                             Header="启用自动提醒?" Description="控制全局的自动提醒启用状态。">
                            <fa:SettingsExpander.Footer>
                                <ToggleSwitch IsChecked="{Binding ViewModel.Settings.GlobalEnableNotification}"/>
                            </fa:SettingsExpander.Footer>
                        </fa:SettingsExpander>
                        
                        <fa:SettingsExpander IconSource="{ci:FluentIconSource &#xE4C4;}"
                                             IsVisible="{Binding ViewModel.Settings.GlobalEnableNotification}"
                                             Header="自动提醒时间获取来源" Description="控制全局的自动提醒时间获取来源。">
                            <fa:SettingsExpander.Footer>
                                <Grid>
                                    <TabStrip Classes="compact toggle" Theme="{StaticResource TabStripStyle}"
                                              SelectedIndex="{Binding ViewModel.Settings.TimeSource}">
                                        <TabStripItem>
                                            <ci:IconText Classes="display-role" Glyph="&#xE47A;" Text="ClassIsland" />
                                        </TabStripItem>
                                        <TabStripItem>
                                            <ci:IconText Classes="display-role" Glyph="&#xF0BD;" Text="系统" />
                                        </TabStripItem>
                                    </TabStrip>
                                </Grid>
                            </fa:SettingsExpander.Footer>
                        </fa:SettingsExpander>
                        
                        <fa:SettingsExpander IconSource="{ci:FluentIconSource &#xE4E8;}"
                                             Header="启用遥测?" Description="控制 DutyIsland 的 Sentry 遥测启用状态。本插件通过 SentrySDK 来收集本应用中的使用情况与错误信息，以改进本插件。您的信息会匿名上传，不会包含您的个人信息。您可以自行启用或禁用此功能。">
                            <fa:SettingsExpander.Footer>
                                <ToggleSwitch IsChecked="{Binding ViewModel.Settings.EnableSentry}"/>
                            </fa:SettingsExpander.Footer>
                        </fa:SettingsExpander>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>
        
        <Border Grid.Row="1" VerticalAlignment="Stretch" HorizontalAlignment="Stretch"
                Background="{DynamicResource LayerOnMicaBaseAltFillColorDefaultBrush}">
            <fa:CommandBar HorizontalAlignment="Right" DefaultLabelPosition="Right">
                <fa:CommandBar.PrimaryCommands>
                    <fa:CommandBarButton IconSource="{ci:FluentIconSource &#xEEB5;}" Label="保存"
                                         ToolTip.Tip="保存当前档案文件。"
                                         Click="ButtonSave_OnClick"/>
                    <!-- <fa:CommandBarButton IconSource="{ci:FluentIconSource &#xEE2F;}" -->
                    <!--                      Label="帮助" -->
                    <!--                      Command="{x:Static ci:UriNavigationCommands.UriNavigationCommand}" -->
                    <!--                      CommandParameter="https://docs.classisland.tech/app/profile/" -->
                    <!--                      ToolTip.Tip="查看值日表编辑器帮助"/> -->
                </fa:CommandBar.PrimaryCommands>
            </fa:CommandBar>
        </Border>
    </Grid>
</ci:SettingsPageBase>