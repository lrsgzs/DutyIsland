<ci:SettingsPageBase x:Class="DutyIsland.Views.SettingPages.DutyRollingSettingsPage"
                     xmlns="https://github.com/avaloniaui"
                     xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                     xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                     xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                     xmlns:ci="http://classisland.tech/schemas/xaml/core"
                     xmlns:fa="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
                     xmlns:local="clr-namespace:DutyIsland.Views.SettingPages"
                     xmlns:enums="clr-namespace:DutyIsland.Enums"
                     xmlns:system="clr-namespace:System;assembly=System.Runtime"
                     x:DataType="local:DutyRollingSettingsPage"
                     d:DataContext="{d:DesignInstance local:DutyRollingSettingsPage}"
                     mc:Ignorable="d">
    <ci:SettingsPageBase.Resources>
        <system:String x:Key="NoDutyPlanString">未绑定值日表</system:String>
    </ci:SettingsPageBase.Resources>

    <Grid RowDefinitions="*, Auto">
        <TabControl Grid.Row="0">
            <TabItem IsEnabled="False">
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontSize="20">DutyIsland</TextBlock>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <ci:Empty Text="你真厉害，居然来到这里了。"
                          Icon="{ci:FluentIconSource &#xE059;, FontSize=48}"/>
            </TabItem>
           
            <TabItem IsSelected="True">
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <ci:FluentIcon Glyph="&#xE356;" FontSize="20" Height="20" VerticalAlignment="Center" />
                            <TextBlock FontSize="20">轮换</TextBlock>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <Grid RowDefinitions="Auto *"
                      IsEnabled="{Binding ViewModel.Settings.DutyPlanGetMode, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static enums:DutyPlanGetMode.AutoRolling}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="5" />
                        <ColumnDefinition Width="350" MinWidth="300" MaxWidth="450" />
                    </Grid.ColumnDefinitions>
                    
                    <fa:CommandBar Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="3"
                                   DefaultLabelPosition="Right" Classes="hide-popup-indicator">
                        <fa:CommandBar.PrimaryCommands>
                            <fa:CommandBarButton Click="ButtonAddRollItem_OnClick" 
                                                 IconSource="{ci:FluentIconSource &#xE308;}"
                                                 Label="添加" ToolTip.Tip="添加轮换项目。"/>
                            
                            <fa:CommandBarButton Click="ButtonRemoveRollItem_OnClick"
                                                 Label="删除" ToolTip.Tip="删除选中的轮换项目。"
                                                 IsEnabled="{Binding ViewModel.SelectedRollItem, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <fa:CommandBarButton.IconSource>
                                    <fa:SymbolIconSource Symbol="Remove"/>
                                </fa:CommandBarButton.IconSource>
                            </fa:CommandBarButton>
                        </fa:CommandBar.PrimaryCommands>
                    </fa:CommandBar>
                        
                    <ScrollViewer Grid.Row="1" Grid.Column="0">
                        <Grid ColumnDefinitions="Auto *">
                            <ListBox Grid.Column="0"
                                     IsEnabled="False" SelectedIndex="{Binding ViewModel.Rolling.RollIndex, Mode=OneWay}"
                                     ItemsSource="{Binding ViewModel.RollIndexItems}">
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <VirtualizingStackPanel Classes="animated-intro" />
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                                
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock HorizontalAlignment="Right" VerticalAlignment="Center" Text="{Binding}" />
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                            
                            <ListBox Grid.Column="1"
                                     Classes="drag"
                                     SelectionMode="Single"
                                     ItemsSource="{Binding ViewModel.Rolling.RollItems}"
                                     SelectedItem="{Binding ViewModel.SelectedRollItem}">
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <VirtualizingStackPanel Classes="animated-intro" />
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                            
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="8">
                                            <ci:TouchDragThumb Margin="-12 0 0 0"
                                                               VerticalAlignment="Center"
                                                               Width="20" IsExplicitVisible="True" />
                                        
                                            <TextBlock VerticalAlignment="Center"
                                                       Text="无值日安排"
                                                       IsVisible="{Binding !HasDutyPlan}"/>
                                        
                                            <TextBlock VerticalAlignment="Center"
                                                       Text="{Binding DutyPlan.Name, FallbackValue={StaticResource NoDutyPlanString}}"
                                                       IsVisible="{Binding HasDutyPlan}" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </ScrollViewer>
                    
                    <GridSplitter Grid.Row="1" Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" />

                    <ScrollViewer Grid.Row="1" Grid.Column="2" Margin="8">
                        <Grid RowDefinitions="Auto, Auto, Auto">
                            <StackPanel Grid.Row="0" Spacing="4">
                                <TextBlock Text="轮换设置" Theme="{StaticResource SubtitleTextBlockStyle}" />
                                
                                <ci:Field Label="当前轮换索引">
                                    <NumericUpDown Value="{Binding ViewModel.Rolling.RollIndex}" Increment="1" FormatString="0" />
                                </ci:Field>
                                
                                <ci:Field Label="轮换间隔天数">
                                    <NumericUpDown Value="{Binding ViewModel.Rolling.RollDays}" Increment="1" FormatString="0" />
                                </ci:Field>
                                
                                <CheckBox IsChecked="{Binding ViewModel.Rolling.RollOnUnopenDay}">
                                    未开启 ClassIsland 也轮换
                                </CheckBox>
                                
                                <CheckBox IsChecked="{Binding ViewModel.Rolling.SkipWeekend}">
                                    跳过周末
                                </CheckBox>
                                
                                <CheckBox IsEnabled="False">
                                    跳过节假日(还未新建文件夹)
                                </CheckBox>
                                
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock VerticalAlignment="Center" Text="上次轮换日期：" />
                                    <TextBlock VerticalAlignment="Center" Text="{Binding ViewModel.Rolling.LastChangedDate}" />
                                    <Button Margin="4 0 0 0" VerticalAlignment="Center"
                                            Click="ButtonManualUpdateRolling_OnClick"
                                            ToolTip.Tip="适用于半夜不关 ci">
                                        手动触发更新
                                    </Button>
                                </StackPanel>
                            </StackPanel>
                            
                            <Separator Grid.Row="1" Margin="-8 16"/>
                            
                            <ci:Emptiable Grid.Row="2" IsDirectContentMode="True"
                                          Data="{Binding ViewModel.SelectedRollItem}">
                                <StackPanel Spacing="8">
                                    <TextBlock Text="轮换项目信息" Theme="{StaticResource SubtitleTextBlockStyle}"/>
                                    
                                    <CheckBox IsChecked="{Binding ViewModel.SelectedRollItem.HasDutyPlan}">
                                        有值日安排?
                                    </CheckBox>
                                    
                                    <ComboBox ItemsSource="{Binding ViewModel.DutyPlans.List}"
                                              SelectedValue="{Binding ViewModel.SelectedRollItem.DutyPlanGuid}"
                                              SelectedValueBinding="{Binding Key}">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Value.Name}"
                                                           ToolTip.Tip="{Binding Key}" />
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                            </ci:Emptiable> 
                        </Grid>
                    </ScrollViewer>
                </Grid>
            </TabItem>
        </TabControl>
        
        <Border Grid.Row="1" VerticalAlignment="Stretch" HorizontalAlignment="Stretch"
                Background="{DynamicResource LayerOnMicaBaseAltFillColorDefaultBrush}">
            <Grid ColumnDefinitions="Auto * Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" Margin="8 0 0 0">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="值日表获取来源:" VerticalAlignment="Center" />
                        
                        <TabStrip Classes="compact toggle" Theme="{StaticResource TabStripStyle}"
                                  VerticalAlignment="Center"
                                  SelectedIndex="{Binding ViewModel.Settings.DutyPlanGetMode}">
                            <TabStripItem>
                                <ci:IconText Classes="display-role" Glyph="&#xE6B1;" Text="附加设置" />
                            </TabStripItem>
                            <TabStripItem>
                                <ci:IconText Classes="display-role" Glyph="&#xE356;" Text="轮换" />
                            </TabStripItem>
                        </TabStrip>
                        
                        <Button Theme="{StaticResource TransparentButton}" VerticalAlignment="Center"
                                Content="{ci:FluentIcon &#xEE31;}">
                            <Button.Flyout>
                                <Flyout>
                                    <Grid RowDefinitions="Auto, Auto" ColumnDefinitions="*, *">
                                        <TextBlock Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2">
                                            <Run Text="说明" FontWeight="Bold" />
                                        </TextBlock>
                                
                                        <SelectableTextBlock Grid.Row="1" Grid.Column="0" Margin="0 0 4 0" TextWrapping="Wrap">
                                            <Run Text="控制全局的值日表获取来源，"/><LineBreak/>
                                            <Run Text="选中「附加设置」时将会从当前启用的课表中的「值日表」附加设置获取，"/><LineBreak/>
                                            <Run Text="选中「轮换」时将会从轮换设置中获取。"/><LineBreak/>
                                        </SelectableTextBlock>
                                    </Grid>
                                </Flyout>
                            </Button.Flyout>
                        </Button>
                    </StackPanel>
                </StackPanel>
                
                <fa:CommandBar Grid.Column="2" HorizontalAlignment="Right" DefaultLabelPosition="Right">
                    <fa:CommandBar.PrimaryCommands>
                        <fa:CommandBarButton IconSource="{ci:FluentIconSource &#xEEB5;}" Label="保存"
                                             ToolTip.Tip="保存当前档案文件。"
                                             Click="ButtonSave_OnClick"/>
                        <!-- <fa:CommandBarButton IconSource="{ci:FluentIconSource &#xEE2F;}" -->
                        <!--                      Label="帮助" -->
                        <!--                      Command="{x:Static ci:UriNavigationCommands.UriNavigationCommand}" -->
                        <!--                      CommandParameter="https://docs.classisland.tech/app/profile/" -->
                        <!--                      ToolTip.Tip="查看值日表编辑器帮助"/> -->
                    </fa:CommandBar.PrimaryCommands>
                </fa:CommandBar>
            </Grid>
        </Border>
    </Grid>
</ci:SettingsPageBase>